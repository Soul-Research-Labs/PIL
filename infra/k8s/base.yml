# ZASEON Kubernetes Infrastructure
# Namespace, ConfigMap, Secrets, Deployments, Services, Ingress

---
# ── Namespace ────────────────────────────────────────────────────────────────
apiVersion: v1
kind: Namespace
metadata:
  name: zaseon
  labels:
    app.kubernetes.io/name: zaseon
    app.kubernetes.io/part-of: zaseon

---
# ── ConfigMap ────────────────────────────────────────────────────────────────
apiVersion: v1
kind: ConfigMap
metadata:
  name: zaseon-config
  namespace: zaseon
data:
  ZASEON_APP_ENV: "production"
  ZASEON_DEBUG: "false"
  ZASEON_REDIS_URL: "redis://zaseon-redis:6379/0"
  ZASEON_CELERY_BROKER_URL: "redis://zaseon-redis:6379/1"
  ZASEON_CELERY_RESULT_BACKEND: "redis://zaseon-redis:6379/2"
  ZASEON_S3_ENDPOINT: "http://zaseon-minio:9000"
  ZASEON_S3_BUCKET_REPOS: "zaseon-repos"
  ZASEON_S3_BUCKET_REPORTS: "zaseon-reports"
  ZASEON_S3_BUCKET_ARTIFACTS: "zaseon-artifacts"
  ZASEON_SOUL_FUZZ_DEFAULT_MODE: "standard"
  ZASEON_SOUL_FUZZ_MAX_DURATION: "300"
  ZASEON_SOUL_FUZZ_MAX_ITERATIONS: "50000"
  ZASEON_SOUL_FUZZ_PARALLEL_WORKERS: "4"
  ZASEON_SOUL_FUZZ_ENABLE_LLM: "true"

---
# ── Secrets (MUST be replaced before applying — never commit real values) ────
# SECURITY: Use an external secrets operator (e.g. Sealed Secrets, External
# Secrets Operator, Vault) instead of committing secret values.
# These placeholders will INTENTIONALLY FAIL on apply to prevent accidental use.
apiVersion: v1
kind: Secret
metadata:
  name: zaseon-secrets
  namespace: zaseon
  annotations:
    security.zaseon.io/warning: "Replace all values before applying. Do not commit real secrets."
type: Opaque
stringData:
  ZASEON_SECRET_KEY: "REPLACE-ME-OR-USE-EXTERNAL-SECRETS-OPERATOR"
  ZASEON_DATABASE_URL: "REPLACE-ME-OR-USE-EXTERNAL-SECRETS-OPERATOR"
  ZASEON_POSTGRES_PASSWORD: "REPLACE-ME-OR-USE-EXTERNAL-SECRETS-OPERATOR"
  ZASEON_ANTHROPIC_API_KEY: ""
  ZASEON_OPENAI_API_KEY: ""
  ZASEON_GITHUB_APP_ID: ""
  ZASEON_GITHUB_APP_PRIVATE_KEY: ""
  ZASEON_GITHUB_WEBHOOK_SECRET: ""
  ZASEON_ETHERSCAN_API_KEY: ""
  ZASEON_S3_ACCESS_KEY: "REPLACE-ME-OR-USE-EXTERNAL-SECRETS-OPERATOR"
  ZASEON_S3_SECRET_KEY: "REPLACE-ME-OR-USE-EXTERNAL-SECRETS-OPERATOR"
  ZASEON_REDIS_PASSWORD: "REPLACE-ME-OR-USE-EXTERNAL-SECRETS-OPERATOR"

---
# ── PostgreSQL ───────────────────────────────────────────────────────────────
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: zaseon-postgres
  namespace: zaseon
spec:
  serviceName: zaseon-postgres
  replicas: 1
  selector:
    matchLabels:
      app: zaseon-postgres
  template:
    metadata:
      labels:
        app: zaseon-postgres
    spec:
      containers:
        - name: postgres
          image: pgvector/pgvector:pg16
          ports:
            - containerPort: 5432
          env:
            - name: POSTGRES_USER
              value: "zaseon"
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: zaseon-secrets
                  key: ZASEON_POSTGRES_PASSWORD
            - name: POSTGRES_DB
              value: "zaseon"
          volumeMounts:
            - name: pgdata
              mountPath: /var/lib/postgresql/data
          resources:
            requests:
              cpu: 250m
              memory: 512Mi
            limits:
              cpu: "1"
              memory: 2Gi
          livenessProbe:
            exec:
              command: ["pg_isready", "-U", "zaseon"]
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            exec:
              command: ["pg_isready", "-U", "zaseon"]
            initialDelaySeconds: 5
            periodSeconds: 5
  volumeClaimTemplates:
    - metadata:
        name: pgdata
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 20Gi

---
apiVersion: v1
kind: Service
metadata:
  name: zaseon-postgres
  namespace: zaseon
spec:
  selector:
    app: zaseon-postgres
  ports:
    - port: 5432
      targetPort: 5432
  clusterIP: None

---
# ── Redis ────────────────────────────────────────────────────────────────────
apiVersion: apps/v1
kind: Deployment
metadata:
  name: zaseon-redis
  namespace: zaseon
spec:
  replicas: 1
  selector:
    matchLabels:
      app: zaseon-redis
  template:
    metadata:
      labels:
        app: zaseon-redis
    spec:
      containers:
        - name: redis
          image: redis:7-alpine
          command:
            - redis-server
            - --requirepass
            - $(REDIS_PASSWORD)
          env:
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: zaseon-secrets
                  key: ZASEON_REDIS_PASSWORD
          ports:
            - containerPort: 6379
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi
          livenessProbe:
            exec:
              command: ["redis-cli", "ping"]
            periodSeconds: 10
          readinessProbe:
            exec:
              command: ["redis-cli", "ping"]
            periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: zaseon-redis
  namespace: zaseon
spec:
  selector:
    app: zaseon-redis
  ports:
    - port: 6379
      targetPort: 6379

---
# ── Engine API ───────────────────────────────────────────────────────────────
apiVersion: apps/v1
kind: Deployment
metadata:
  name: zaseon-engine
  namespace: zaseon
spec:
  replicas: 2
  selector:
    matchLabels:
      app: zaseon-engine
  template:
    metadata:
      labels:
        app: zaseon-engine
    spec:      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000      containers:
        - name: engine
          image: ghcr.io/OWNER/zaseon/engine:2.1.0
          ports:
            - containerPort: 8000
          envFrom:
            - configMapRef:
                name: zaseon-config
            - secretRef:
                name: zaseon-secrets
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: "2"
              memory: 4Gi
          livenessProbe:
            httpGet:
              path: /api/health
              port: 8000
            initialDelaySeconds: 15
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /api/health
              port: 8000
            initialDelaySeconds: 5
            periodSeconds: 10
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop: ["ALL"]

---
apiVersion: v1
kind: Service
metadata:
  name: zaseon-engine
  namespace: zaseon
spec:
  selector:
    app: zaseon-engine
  ports:
    - port: 8000
      targetPort: 8000

---
# ── Celery Worker ────────────────────────────────────────────────────────────
apiVersion: apps/v1
kind: Deployment
metadata:
  name: zaseon-worker
  namespace: zaseon
spec:
  replicas: 2
  selector:
    matchLabels:
      app: zaseon-worker
  template:
    metadata:
      labels:
        app: zaseon-worker
    spec:      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000      containers:
        - name: worker
          image: ghcr.io/OWNER/zaseon/engine:2.1.0
          command:
            [
              "celery",
              "-A",
              "engine.pipeline.tasks",
              "worker",
              "--loglevel=info",
              "--concurrency=4",
            ]
          envFrom:
            - configMapRef:
                name: zaseon-config
            - secretRef:
                name: zaseon-secrets
          resources:
            requests:
              cpu: "1"
              memory: 2Gi
            limits:
              cpu: "4"
              memory: 8Gi
          livenessProbe:
            exec:
              command: ["celery", "-A", "engine.pipeline.tasks", "inspect", "ping"]
            initialDelaySeconds: 30
            periodSeconds: 60
            timeoutSeconds: 10
          readinessProbe:
            exec:
              command: ["celery", "-A", "engine.pipeline.tasks", "inspect", "ping"]
            initialDelaySeconds: 10
            periodSeconds: 30
            timeoutSeconds: 10
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop: ["ALL"]

---
# ── Web (Next.js) ───────────────────────────────────────────────────────────
apiVersion: apps/v1
kind: Deployment
metadata:
  name: zaseon-web
  namespace: zaseon
spec:
  replicas: 2
  selector:
    matchLabels:
      app: zaseon-web
  template:
    metadata:
      labels:
        app: zaseon-web
    spec:      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000      containers:
        - name: web
          image: ghcr.io/OWNER/zaseon/web:2.1.0
          ports:
            - containerPort: 3000
          env:
            - name: NEXT_PUBLIC_API_URL
              value: "https://api.zaseon.dev"
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
          livenessProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 10
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 5
            periodSeconds: 10

---
apiVersion: v1
kind: Service
metadata:
  name: zaseon-web
  namespace: zaseon
spec:
  selector:
    app: zaseon-web
  ports:
    - port: 3000
      targetPort: 3000

---
# ── Ingress ──────────────────────────────────────────────────────────────────
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: zaseon-ingress
  namespace: zaseon
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/limit-rps: "30"
    nginx.ingress.kubernetes.io/limit-burst-multiplier: "5"
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-Frame-Options: DENY";
      more_set_headers "Referrer-Policy: strict-origin-when-cross-origin";
      more_set_headers "Permissions-Policy: camera=(), microphone=(), geolocation=()";
      more_set_headers "Strict-Transport-Security: max-age=63072000; includeSubDomains; preload";
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - zaseon.dev
        - api.zaseon.dev
      secretName: zaseon-tls
  rules:
    - host: zaseon.dev
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: zaseon-web
                port:
                  number: 3000
    - host: api.zaseon.dev
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: zaseon-engine
                port:
                  number: 8000

---
# ── HorizontalPodAutoscaler ─────────────────────────────────────────────────
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: zaseon-engine-hpa
  namespace: zaseon
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: zaseon-engine
  minReplicas: 2
  maxReplicas: 8
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70

---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: zaseon-worker-hpa
  namespace: zaseon
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: zaseon-worker
  minReplicas: 2
  maxReplicas: 16
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 80
