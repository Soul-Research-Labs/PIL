# ZASEON External Secrets — AWS Secrets Manager integration
#
# Replaces hardcoded K8s Secret stringData with references to
# AWS Secrets Manager, using the External Secrets Operator (ESO).
#
# Prerequisites:
#   1. Install ESO: helm install external-secrets external-secrets/external-secrets -n external-secrets --create-namespace
#   2. Create IAM role with SecretsManager read access
#   3. Store secrets in AWS Secrets Manager under /zaseon/{env}/*

---
# ── ClusterSecretStore — shared AWS SM backend ──────────────────────────────
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: zaseon-aws-sm
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa
            namespace: external-secrets

---
# ── ExternalSecret — maps AWS SM keys to K8s Secret ────────────────────────
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: zaseon-secrets
  namespace: zaseon
  labels:
    app.kubernetes.io/name: zaseon
    app.kubernetes.io/component: secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: zaseon-aws-sm
    kind: ClusterSecretStore

  target:
    name: zaseon-secrets
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: zaseon

  data:
    - secretKey: ZASEON_SECRET_KEY
      remoteRef:
        key: /zaseon/production/secret-key

    - secretKey: ZASEON_DATABASE_URL
      remoteRef:
        key: /zaseon/production/database-url

    - secretKey: ZASEON_POSTGRES_PASSWORD
      remoteRef:
        key: /zaseon/production/postgres-password

    - secretKey: ZASEON_ANTHROPIC_API_KEY
      remoteRef:
        key: /zaseon/production/anthropic-api-key

    - secretKey: ZASEON_OPENAI_API_KEY
      remoteRef:
        key: /zaseon/production/openai-api-key

    - secretKey: ZASEON_GITHUB_APP_ID
      remoteRef:
        key: /zaseon/production/github-app-id

    - secretKey: ZASEON_GITHUB_APP_PRIVATE_KEY
      remoteRef:
        key: /zaseon/production/github-app-private-key

    - secretKey: ZASEON_GITHUB_WEBHOOK_SECRET
      remoteRef:
        key: /zaseon/production/github-webhook-secret

    - secretKey: ZASEON_ETHERSCAN_API_KEY
      remoteRef:
        key: /zaseon/production/etherscan-api-key

    - secretKey: ZASEON_S3_ACCESS_KEY
      remoteRef:
        key: /zaseon/production/s3-access-key

    - secretKey: ZASEON_S3_SECRET_KEY
      remoteRef:
        key: /zaseon/production/s3-secret-key

---
# ── ServiceAccount for IRSA (IAM Roles for Service Accounts) ───────────────
apiVersion: v1
kind: ServiceAccount
metadata:
  name: external-secrets-sa
  namespace: external-secrets
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/zaseon-external-secrets
